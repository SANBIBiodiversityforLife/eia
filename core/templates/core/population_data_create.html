{% extends "core/_base_dataset_create_form.html" %}
{% load bootstrap3 %}
{% load leaflet_tags %}
{% load static %}

{% block sub-css %}
<!-- Intro.js (mapping help) -->
<link href='{% static "node_modules/intro.js/minified/introjs.min.css" %}' rel="stylesheet">
<style>
.introjs-fixParent {
  position: relative !important;
}
</style>

<!-- Leaflet -->
{% leaflet_js plugins="forms,draw" %}
{% leaflet_css plugins="forms,draw" %}

<!-- Chosen -->
<link href='{% static "chosen/chosen.min.css" %}' rel="stylesheet">
{% endblock %}

{% block parent-link %}<a href="{% url 'population_data' project.id %}">Population data</a>{% endblock %}
{% block breadcrumb-text %}{% block header-detail-text %}population{% endblock %}{% endblock %}

{% block upload-form %}
  <form role="form" class="data-upload-form" id="populationLocationForm" action="" method="post">{% csrf_token %}
    <div class="step" id="step1">
      <span class="step-number">1</span>
      <h2>Where was your data collected from?</h2>
      <p>The project area is pre-loaded by default. If your data comes from a smaller area within the project area,
        <a href="#" onClick="startIntro()"  data-toggle="tooltip" data-placement="right" title="Click to learn how to use our maps">load a KML or GPX, or draw it in on the map
          <span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span></a>.</p>

          {% bootstrap_form_errors map_form %}
          {% for field in map_form %}
            {% if field.name == "location" %}{% bootstrap_field field %}{% endif %}
          {% endfor %}
      <a id="stepLink" href="#step2" class="btn btn-default">
        <span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span> Next
      </a>
    </div>

    <div class="step" id="step2">
      <span class="step-number">2</span>
      <h2>How was your data collected?</h2>
      {% for field in map_form %}
        {% if field.name != "location" %}{% bootstrap_field field %}{% endif %}
      {% endfor %}
      <a id="stepLink2" href="#step3" class="btn btn-default">
        <span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span> Next
      </a>
    </div>

    <div class="step" id="step3">
      <span class="step-number">3</span>
      <h2>Add your data</h2>

      <!-- Instructions -->
      <div class="step-instructions">
        <ul class="list-unstyled">
          <li>
            <span class="glyphicon glyphicon-stats" aria-hidden="true"></span>
            This should be your <strong>estimates of the numbers (absolute abundance/density or relative abundance)</strong>
            of each species in the area you surveyed.
          </li>
          <li>
            <span class="glyphicon glyphicon-tree-deciduous" aria-hidden="true"></span>
            The survey techniques used <strong>must correspond to the latest edition of the
            <a href="#">Birds and Wind-Energy Best-Practice Guidelines</a></strong>, (e.g. walked and driven transects,
            fixed-point counts, checklist surveys) or the ?? for bats
          </li>
          <li>
            <span class="glyphicon glyphicon-indent-left" aria-hidden="true"></span>
            <strong>More rows</strong> will get added automatically to the bottom as you paste or enter data.
          </li>
          <li>
            <span class="glyphicon glyphicon-fullscreen" aria-hidden="true"></span>
            You may <strong>split up your data</strong> and upload it in as many sections as you wish.
          </li>
          <li>
            <span class="glyphicon glyphicon-warning-sign" aria-hidden="true"></span>
            If you have surveyed a <strong>focal site</strong> (e.g. a wetland, dam or roosting tree),
            please <a href="{% url 'focal_site_data' project.id %}">upload these data separately using the focal site form</a>.
          </li>
        </ul>
      </div>

      <!-- Table example -->
      <button id="showExamples" type="button" class="btn btn-warning">
        <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span> See an example
      </button>
      <div class="hot-example-wrapper"><table class="table hot-example">
        <tbody><tr>
          <td>Start typing common name or scientific name, e.g. <strong>"Eudyptes moseleyi"</strong> or <strong>"Northern Rockhopper"</strong>
            <br><span class="glyphicon glyphicon-arrow-down" aria-hidden="true"></span></td>
          <td>E.g. <strong>"2"</strong>
            <br><span class="glyphicon glyphicon-arrow-down" aria-hidden="true"></span></td>
          <td>Click the arrow in the right of the cell to bring up a calendar. E.g. <strong>"2011/11/01"</strong> or <strong>"01/11/2011"</strong>
            <br><span class="glyphicon glyphicon-arrow-down" aria-hidden="true"></span></td>
          <td>E.g. <strong>"23"</strong> for 11pm or <strong>"9"</strong> for 9am
            <br><span class="glyphicon glyphicon-arrow-down" aria-hidden="true"></span></td>
          <td>Relative abundance is per km<sup>2</sup>, Absolute is the total number counted. E.g. <strong>"Relative"</strong>
            <br><span class="glyphicon glyphicon-arrow-down" aria-hidden="true"></span></td>
          <td>E.g. <strong>"0-10"</strong> or <strong>"50-100"</strong>. If not relevant, leave blank.
            <br><span class="glyphicon glyphicon-arrow-down" aria-hidden="true"></span></td>
        </tr></tbody>
      </table></div>

      <!-- HOT table itself -->
      <div id="hot-wrapper"><div id="hot"></div></div>

      <!-- Submit button -->
      <p><strong>Finished? Once you have pressed "Upload" you will be given the opportunity to add your raw data sheets or any documentation you might feel is useful.</strong></p>
      <button id="submitData" type="button" class="btn btn-primary">Upload</button>
      <a href="{% url 'population_data' project.id %}" type="button" class="btn btn-default">Cancel</a>
    </div>
  </form>
{% endblock %}

<!-- This success URL gets changed to the correct metadata via js when the AJAX comes back, see init_hot.js -->
{% block success-url %}{% url 'population_data' project.id %}{% endblock %}

{% block sub-js %}
<!-- Map help -->
<script src='{% static "node_modules/intro.js/minified/intro.min.js" %}'></script>
<script src='{% static "core/js/map-help.js" %}'></script>

<!-- Map -->
<script src='{% static "leaflet-filelayer/leaflet.filelayer.js" %}'></script>
<script src='{% static "leaflet-filelayer/togeojson/togeojson.js" %}'></script>
<script src='{% static "temp-leaflet.forms.js" %}'></script> <!-- Temporary until update -->
<script src='{% static "core/js/eia-filelayer.js" %}'></script>

<!-- Chosen -->
<script src='{% static "chosen/chosen.jquery.min.js" %}'></script>

<!-- Reformats time so multiple time formats can be pasted in e.g. 23h00 -->
<script src='{% static "core/js/clean_time.js" %}'></script>

<!-- Hands On Table and Tooltips -->
<script type="text/javascript">
// Widths of the columns - this is also used for hot-examples.js included later
widths = [240, 50, 100, 90, 80, 200];
$(document).ready(function() {
    // Tooltips
    $(function () {
      $('[data-toggle="tooltip"]').tooltip()
    })

    // Chosen
    $("select#id_survey_types").chosen();

    // Run to pass in the correct value to the validator
    // Should be able to remove it once https://github.com/handsontable/handsontable/issues/3402 is resolved
    hotOptions['beforeValidate'] = function (value, row, prop, source) {
        if(prop == 3) {
            val = cleanTime(value);
            return val;
        }
    };

    // Should change cell value before validation, but currently does not
    hotOptions['beforeChange'] = function (changes, source) {
        for(var i = changes.length - 1; i >= 0; i--) {
          if(changes[i][1] === 3) {
            changes[i][3] = cleanTime(changes[i][3]);
          }
        }
    };

    // Handsontable options
    hotOptions['colWidths'] = widths;
    hotOptions['columns'] = [
      {
        type: 'autocomplete',
        source: {{ taxa|safe }},
        strict: true
      },
      {
        type: 'numeric',
        format: '00',
        validator: /^\d+$/
      },
      {
        type: 'date',
        dateFormat: 'DD/MM/YYYY',
        correctFormat: true,
        defaultDate: new Date(),
      },
      {
        type: 'numeric',
        format: '00',
        default: '00',
        validator: /^([01]?[0-9]|2[0-3])$/
      },
      {
        type: 'autocomplete',
        source: {{ count_types|safe }},
        strict: true
      },
      {
        validator: /^(\d\d?\d?\s*-\s*\d\d?\d?|null)$/
      }
    ];

    // Hide step divs
    $('#upload-form-wrapper #step2').hide();
    $('#upload-form-wrapper #step3').hide();

    // Show step divs when you click through
    $('#stepLink').click(function() {
      $('#upload-form-wrapper #step2').show('fast');

      // Smooth scrolling for the next button
      $('html, body').animate({
          scrollTop: $( $.attr(this, 'href') ).offset().top
      }, 200);
    });

    // We only want to initalise handsontable once the div is visible
    $('#stepLink2').click(function() {
      // Check that they've filled in some values
      if($('#id_hours').val().length === 0) {
        $('#id_hours').parent().addClass('has-error');
        return false;
      }

      // Show the div, if it's not already visible
      if($('#step3').is(':hidden')) {
        $('#step3').show('fast', function() {
          // Function to initialise handsontable is stored in init_hot.js
          init_hot();

          // Fix example widths - see hot-examples.js
          fixExampleWidths(widths);
        });
      }

      // Smooth scrolling for the next button
      $('html, body').animate({
          scrollTop: $( $.attr(this, 'href') ).offset().top
      }, 400);

      // StepLink click should return false
      return false;
    });
  })
</script>
{% endblock %}
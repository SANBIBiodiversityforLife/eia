{% extends "core/_base.html" %}
{% load static %}
{% load bootstrap3 %}

{% block breadcrumb %}
<ol class="breadcrumb">
  <li><a href="#">Home</a></li>
  <li><a href="{% url 'projects_list' %}">Projects</a></li>
  {% with request.resolver_match.url_name as url_name %}
  {% if url_name == 'project_detail' %}<li class="active">{{ project.name }}</li>
    {% else %}
      <li><a href="{% url 'project_detail' project.id %}">{{ project.name }}</a></li>
      <li class="active">
        {% if url_name == 'population_data' %}
          Population data
        {% elif url_name == 'focal_site_data' %}
          Focal site data
        {% elif url_name == 'fatality_data' %}
          Fatality data
        {% endif %}
      </li>
    {% endif %}
  {% endwith %}
</ol>
{% endblock breadcrumb %}

{% block header-text %}{{ project }} <small>{{ project.developer }} - EIA: {{ project.eia_number }}</small>{% endblock %}

{% block content %}
  <ul class="nav nav-tabs">
    {% with request.resolver_match.url_name as url_name %}
    <li role="presentation" class="{% if url_name == 'project_detail' %}active{% endif %}">
      <a href="{% url 'project_detail' project.id %}">Details</a></li>
    <li role="presentation" class="{% if url_name == 'population_data' %}active{% endif %}">
      <a href="{% url 'population_data' project.id %}">Populations</a></li>
    <li role="presentation" class="{% if url_name == 'focal_site_data' %}active{% endif %}">
      <a href="{% url 'focal_site_data' project.id %}">Focal sites</a></li>
    <li role="presentation" class="{% if url_name == 'fatality_data' %}active{% endif %}">
      <a href="{% url 'fatality_data' project.id %}">Fatalities</a></li>
    {% endwith %}
  </ul>

  <h3>{% block subcontent-heading %}{% endblock %}</h3>

  {% block subcontent %}{% endblock %}

  {% if data_set %}
    <form id="selectDataset" method="post">{% csrf_token %}
      {% bootstrap_form form %}
    </form>

    {% block table %}{% endblock %}

    <!-- Flag dataset alert -->
    <div class="alert alert-warning" role="alert">
      <p>
        Does this dataset look incorrect?
        <a id="flagDataset" href="#" type="button"
           class="btn btn-sm btn-danger"  data-toggle="modal" data-target="#flagModal">
          <span class="glyphicon glyphicon-flag" aria-hidden="true"></span> Flag it for removal by an administrator
        </a>
      </p>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="flagModal" tabindex="-1" role="dialog" aria-labelledby="flagModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="flagModalLabel">Flag dataset for removal</h4>
          </div>
          <form id="flagForRemoval" method="post" action="{% url 'flag_for_removal' project.pk %}">{% csrf_token %}
            <div class="modal-body">
              <p>Why should this dataset be removed?</p>
              {% bootstrap_form flag_for_removal_form %}
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              <input type="submit" class="btn btn-danger" id="flagForRemovalButton" value="Flag for removal">
            </div>
          </form>
        </div>
      </div>
    </div>
  {% else %}
  {% block no-data-message %}{% endblock %}
  {% endif %}
{% endblock content %}

{% block js %}
  <script src='{% static "core/js/jquery.form.min.js" %}'></script>
  <script type="text/javascript">
    $(document).ready(function() {
      $('#id_datasets').change(function() {
        $('form#selectDataset').submit();
      });

      // Ajax the form
      var options = {
          dataType: 'json',
          success: function(data) {
              // Change the header
              $('#flagForRemoval .modal-body').html('Dataset has been flagged for removal with an administrator.');
              $('#flagForRemovalButton').hide();
          }
      }
      $('#flagForRemoval').ajaxForm(options);
    });
  </script>
  {% block sub-js %}{% endblock %}
{% endblock js %}